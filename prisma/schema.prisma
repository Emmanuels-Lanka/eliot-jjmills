generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(uuid())
  name       String
  email      String   @unique
  phone      String
  role       String
  password   String
  employeeId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Staff {
  id            String         @id
  name          String
  email         String         @unique
  phone         String
  designation   String
  employeeId    String         @unique
  rfid          String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  gender        String
  alertLogs     AlertLog[]
  obbOperations ObbOperation[]
  accInputMan   ObbSheet[]     @relation("AccInputMan")
  fabInputMan   ObbSheet[]     @relation("FabricInputMan")
  indEngineer   ObbSheet[]     @relation("IndEngineer")
  mechanic      ObbSheet[]     @relation("Mechanic")
  qualityIns    ObbSheet[]     @relation("QI")
  supervisor1   ObbSheet[]     @relation("Supervisor1")
  supervisor2   ObbSheet[]     @relation("Supervisor2")
}

model Operator {
  id               String            @id
  name             String
  employeeId       String            @unique
  rfid             String            @unique
  gender           String
  designation      String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  isLoggedIn       Boolean           @default(false)
  alertLogs        AlertLog[]
  operatorSessions OperatorSession[]
  productionData   ProductionData[]
}

model Unit {
  id              String           @id @default(uuid())
  name            String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  obbSheets       ObbSheet[]
  productionLines ProductionLine[]
  sewingMachines  SewingMachine[]
}

model ProductionLine {
  id        String          @id @default(uuid())
  name      String          @unique
  unitId    String
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  obbSheets ObbSheet[]
  unit      Unit            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  machines  SewingMachine[] @relation("ProductionLineToSewingMachine")

  @@index([unitId])
}

model EliotDevice {
  id             String           @id
  isAssigned     Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  installedDate  String
  modelNumber    String
  serialNumber   String           @unique
  productionData ProductionData[]
  sewingMachines SewingMachine?
}

model SewingMachine {
  id              String           @id @default(uuid())
  brandName       String
  machineType     String
  machineId       String           @unique
  ownership       String
  isAssigned      Boolean          @default(false)
  eliotDeviceId   String?          @unique
  unitId          String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  serialNumber    String           @unique
  obbOperationId  String?          @unique
  modelNumber     String?
  alertLogs       AlertLog[]
  eliotDevice     EliotDevice?     @relation(fields: [eliotDeviceId], references: [id], onDelete: Cascade)
  obbOperation    ObbOperation?    @relation(fields: [obbOperationId], references: [id])
  unit            Unit             @relation(fields: [unitId], references: [id], onDelete: Cascade)
  productionLines ProductionLine[] @relation("ProductionLineToSewingMachine")

  @@index([eliotDeviceId, unitId, obbOperationId])
}

model ObbSheet {
  id               String         @id
  name             String
  productionLineId String
  unitId           String
  indEngineerId    String?
  supervisor1Id    String?
  supervisor2Id    String?
  mechanicId       String?
  qualityInsId     String?
  accInputManId    String?
  fabInputManId    String?
  buyer            String
  style            String
  item             String
  operators        Int
  helpers          Int
  startingDate     String
  endingDate       String
  workingHours     Int
  efficiencyLevel1 Int
  efficiencyLevel2 Int
  efficiencyLevel3 Int
  itemReference    String?
  totalMP          Int?
  totalSMV         Int?
  bottleNeckTarget Int?
  target100        Int?
  ucl              Int?
  lcl              Int?
  balancingLoss    Int?
  balancingRatio   Int?
  colour           String?
  supResponseTime  Int?
  mecResponseTime  Int?
  qiResponseTime   Int?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  obbOperations    ObbOperation[]
  accInputMan      Staff?         @relation("AccInputMan", fields: [accInputManId], references: [id])
  fabInputMan      Staff?         @relation("FabricInputMan", fields: [fabInputManId], references: [id])
  indEngineer      Staff?         @relation("IndEngineer", fields: [indEngineerId], references: [id])
  mechanic         Staff?         @relation("Mechanic", fields: [mechanicId], references: [id])
  productionLine   ProductionLine @relation(fields: [productionLineId], references: [id], onDelete: Cascade)
  qualityIns       Staff?         @relation("QI", fields: [qualityInsId], references: [id])
  supervisor1      Staff?         @relation("Supervisor1", fields: [supervisor1Id], references: [id])
  supervisor2      Staff?         @relation("Supervisor2", fields: [supervisor2Id], references: [id])
  unit             Unit           @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([productionLineId, unitId, indEngineerId, supervisor1Id, supervisor2Id, mechanicId, qualityInsId, accInputManId, fabInputManId])
}

model Operation {
  id            String         @id @default(uuid())
  name          String         @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  obbOperations ObbOperation[]
}

model ObbOperation {
  id               String            @id
  seqNo            Int               @default(0)
  operationId      String
  obbSheetId       String
  smv              Int
  target           Int
  spi              Int
  length           Int
  totalStitches    Int
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  supervisorId     String?
  obbSheet         ObbSheet          @relation(fields: [obbSheetId], references: [id], onDelete: Cascade)
  operation        Operation         @relation(fields: [operationId], references: [id], onDelete: Cascade)
  supervisor       Staff?            @relation(fields: [supervisorId], references: [id])
  operatorSessions OperatorSession[]
  productionData   ProductionData[]
  sewingMachine    SewingMachine?

  @@index([operationId, obbSheetId])
}

model OperatorSession {
  id              String       @id
  operatorRfid    String
  obbOperationId  String
  isLoggedIn      Boolean      @default(true)
  LoginTimestamp  String
  LogoutTimestamp String?
  createdAt       DateTime     @default(now())
  obbOperation    ObbOperation @relation(fields: [obbOperationId], references: [id], onDelete: Cascade)
  operator        Operator     @relation(fields: [operatorRfid], references: [rfid], onDelete: Cascade)

  @@index([operatorRfid, obbOperationId])
}

model StaffSession {
  id              String   @id
  staffEmpId      String
  obbOperationId  String
  isLoggedIn      Boolean  @default(true)
  LoginTimestamp  String
  LogoutTimestamp String?
  createdAt       DateTime @default(now())

  @@index([staffEmpId, obbOperationId])
}

model ProductionData {
  id                String       @id @default(uuid())
  operatorRfid      String
  eliotSerialNumber String
  obbOperationId    String
  productionCount   Int
  timestamp         String
  createdAt         DateTime     @default(now())
  eliotDevice       EliotDevice  @relation(fields: [eliotSerialNumber], references: [serialNumber])
  obbOperation      ObbOperation @relation(fields: [obbOperationId], references: [id], onDelete: Cascade)
  operator          Operator     @relation(fields: [operatorRfid], references: [rfid], onDelete: Cascade)

  @@index([operatorRfid, eliotSerialNumber, obbOperationId])
}

model AlertLog {
  id              String        @id
  machineId       String
  operatorRfid    String
  employeeId      String
  alertType       String
  smsStatus       String        @default("SENDING")
  emailStatus     String        @default("SENDING")
  createdAt       DateTime      @default(now())
  loginTimestamp  String?
  logoutTimestamp String?
  reqTimestamp    String
  employee        Staff         @relation(fields: [employeeId], references: [employeeId], onDelete: Cascade)
  sewingMachine   SewingMachine @relation(fields: [machineId], references: [machineId], onDelete: Cascade)
  operator        Operator      @relation(fields: [operatorRfid], references: [rfid], onDelete: Cascade)

  @@index([machineId, operatorRfid, employeeId])
}

model TrafficLightSystem {
  id             String   @id
  timestamp      String
  machineId      String
  operatorRfid   String
  obbOperationId String
  qcEmail        String?
  createdAt      DateTime @default(now())
  roundNo        Int      @default(1)
  colour         String
}

model SampleTable {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  tagId     String
}
